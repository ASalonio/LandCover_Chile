---
title: "Land_Cover_Analysis"
author: "Augusto Pablo Salonio Carbó"
date: "2025-11-10"
output: html_document
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

This notebook performs a complete land-use change analysis using reclassified ESA CCI land-cover maps (200 m resolution) for 1999, 2009, and 2018.

## Key outputs:

-   Initial area per class (1999)

-   Full transition matrix

-   Sankey diagrams (all + top 15 dynamic)

-   Bar plots of class areas over time

-   Spatial maps of major transitions

## Load packages & Paths

```{r pressure, echo=FALSE}
library(terra)
library(tidyterra)
library(dplyr)
library(tidyr)
library(sf)
library(openxlsx)
library(networkD3)
library(htmlwidgets)
library(webshot)
library(ggplot2)
library(tmap)
library(RColorBrewer)
```

```{r}
in_dir  <- "~/data"
out_dir <- "~/output"
dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)
```

## Load Reclassified Land Cover Rasters and Centro-Sur Region boundaries

```{r}

reclass_cover_1999 <- rast(file.path(in_dir, "reclass_cover_1999.tif"))
reclass_cover_2009 <- rast(file.path(in_dir, "reclass_cover_2009.tif"))
reclass_cover_2018 <- rast(file.path(in_dir, "reclass_cover_2018.tif"))
lim_32719 <- vect("~/AMID/data/Límites/lim_32719.shp")

```

## Area per Class (1999)

```{r}

area_summary <- freq(reclass_cover_1999, by = TRUE)

area_summary$area_ha <- area_summary$count * (res(reclass_cover_1999)[1] * res(reclass_cover_1999)[2]) / 10000

ggplot(area_summary, aes(x = value, y = area_ha)) +
  geom_col(position = "dodge") +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Land Cover Area in 1999", x = "Land Cover", y = "Area (ha)") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Align & Stack Rasters

```{r}
reclass_cover_2009_a <- resample(reclass_cover_2009, reclass_cover_1999, method = "near")
reclass_cover_2018_a <- resample(reclass_cover_2018, reclass_cover_1999, method = "near")
lc_stack <- c(reclass_cover_1999, reclass_cover_2009_a, reclass_cover_2018_a)
```

## Full Transition Table

```{r}
ct_df <- crosstab(lc_stack, useNA = FALSE) %>%
  as.data.frame() %>%
  rename(y1999 = 1, y2009 = 2, y2018 = 3) %>%
  filter(Freq > 0) %>%
  mutate(
    area_m2 = Freq * pixel_area,
    area_ha = area_m2 / 10000,
    Tipo = if_else(y1999 == y2009 & y2009 == y2018, "Estable", "Dinámica")
  ) %>%
  arrange(desc(area_ha))
```

## Sankey: All transitions

```{r}
sankey_data <- function(df, val = "Freq") {
  cls <- unique(c(df$y1999, df$y2009, df$y2018))
  nodes <- data.frame(name = paste0(rep(c("1999_","2009_","2018_"), each=length(cls)), cls))
  links <- rbind(
    data.frame(source = match(df$y1999, cls)-1,
               target = match(df$y2009, cls) + length(cls)-1,
               value = df[[val]]),
    data.frame(source = match(df$y2009, cls) + length(cls)-1,
               target = match(df$y2018, cls) + 2*length(cls)-1,
               value = df[[val]])
  ) %>% group_by(source, target) %>% summarise(value = sum(value), .groups='drop')
  list(nodes = nodes, links = links)
}

sankey_all <- sankey_data(ct_df)
sankeyNetwork(Links = sankey_all$links, Nodes = sankey_all$nodes,
              Source = "source", Target = "target", Value = "value",
              NodeID = "name", fontSize = 12, nodeWidth = 30)
```

## Top 15 Dynamic Transitions

```{r}
ct_major <- ct_df %>% filter(Tipo == "Dinámica") %>% slice_head(n = 15)
sankey_major <- sankey_data(ct_major, "area_ha")
sankeyNetwork(Links = sankey_major$links, Nodes = sankey_major$nodes,
              Source = "source", Target = "target", Value = "value",
              NodeID = "name", fontSize = 12, nodeWidth = 30)
```

## Area per Class Over Time

```{r}
area_time <- ct_df %>%
  pivot_longer(c(y1999, y2009, y2018), names_to = "Year", values_to = "Class") %>%
  mutate(Year = recode(Year, y1999="1999", y2009="2009", y2018="2018"),
         Year = factor(Year, c("1999","2009","2018"))) %>%
  group_by(Year, Class) %>% summarise(area_ha = sum(area_ha), .groups='drop')

ggplot(area_time, aes(x = Class, y = area_ha, fill = Year)) +
  geom_col(position = "dodge") +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Land Cover Area by Year", x = "Land Cover", y = "Area (ha)") +
  theme_minimal() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Top 15 Transitions Map

```{r}

class_names <- c("Water_Bare", "Native", "Plant", "Shrub", 
                 "Crop", "Grass", "Peat", "Urban")

trans_labels <- sapply(trans_freq$value, function(code) {
  v1999 <- floor(code / 100)
  v2009 <- floor((code %% 100) / 10)
  v2018 <- code %% 10
  paste(class_names[v1999], "→", class_names[v2009], "→", class_names[v2018])
})

levels(top15_rast) <- data.frame(
  ID = trans_freq$value,
  Transition = trans_labels
)

tmap_mode("plot")

tm_shape(top15_rast) +
  tm_raster(
    style = "cat",
    palette = "Set3",
    title = "Transition (1999→2009→2018)",
    labels = levels(top15_rast)[[1]]$Transition
  ) +
  tm_shape(lim_32719) +
  tm_borders(col = "black", lwd = 1.2) +
  tm_layout(
    main.title.size = 1.3,
    legend.outside = TRUE,
    legend.outside.position = "right",
    legend.title.size = 1.1,
    legend.text.size = 0.9
  )
```
